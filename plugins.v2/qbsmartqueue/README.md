# qBittorrent 智能体积调度

基于下载体积动态管理 qBittorrent 队列，大文件排队、小文件插队，防止硬盘爆满。

## 功能特性

- **溢出保护** — 活跃下载剩余体积超过上限时，自动暂停最新添加的任务
- **智能放行** — 按策略（先来先到 / 小文件优先）排序，逐个放行不超限的任务
- **小文件插队** — 大文件塞不下时跳过，优先放行后面的小文件
- **低速宽容** — 溢出保护时优先保留低于阈值的低速种子，支持仅对 `stalledDL` 生效
- **防死锁** — 无活跃下载且有等待任务时，强制放行第一个
- **磁盘保护** — 按种子 `save_path` 匹配监控目录，仅暂停处于低空间磁盘上的种子

## 触发方式

| 方式 | 说明 |
|------|------|
| 定时任务 | 按 cron 表达式周期执行（默认每 2 分钟） |
| 事件驱动 | 新下载添加（`DownloadAdded`）时立即触发 |
| 远程命令 | 发送 `/smart_queue` 命令手动触发 |
| 立即运行 | 配置页面勾选「立即运行一次」 |

## 配置说明

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| 启用插件 | 开关 | 关 | 是否启用插件 |
| 发送通知 | 开关 | 开 | 放行、暂停时是否发送消息通知 |
| 立即运行一次 | 开关 | 关 | 保存后立即执行一次调度 |
| 下载器 | 多选 | — | 选择要管理的 qBittorrent 下载器实例 |
| 执行周期 | Cron | `*/2 * * * *` | 定时执行的 cron 表达式 |
| 最大并发下载体积 (GB) | 数字 | 35 | 活跃下载剩余体积上限 |
| 排队策略 | 选择 | 先来先到 | `age`：按添加时间排序；`size`：小文件优先 |
| 小文件插队 | 开关 | 开 | 大文件放不下时跳过，尝试放行后面的小文件 |
| 低速种子宽容 | 开关 | 开 | 溢出保护时优先保留低速种子 |
| 低速阈值 (KiB/s) | 数字 | 100 | 当前下载速度低于该阈值时视为低速种子 |
| 仅 stalledDL 生效 | 开关 | 关 | 开启后仅对 `stalledDL` 状态应用低速宽容 |
| 仅 MoviePilot 任务 | 开关 | 开 | 只管理带有 MoviePilot 标签的种子 |
| 监控下载目录 | 多选 | — | 从目录管理中选择要检测磁盘空间的下载目录 |
| 最低磁盘剩余空间 (GB) | 数字 | 5 | 低于此值时暂停对应目录的下载任务 |

## 调度流程

```
1. 获取所有种子
       │
2. 磁盘空间检查
   └─ 遍历监控目录，找出低空间目录
   └─ 按 save_path 匹配，仅暂停对应种子
       │
3. 分类种子（活跃 / 暂停）
       │
4. 溢出保护
   └─ 活跃剩余体积 > 上限 → 优先暂停非低速种子，必要时再暂停低速种子
       │
5. 排序等待队列（按策略）
       │
6. 逐个放行
   └─ 跳过低空间目录的种子
   └─ 已完成的直接恢复
   └─ 放行后不超限的任务
   └─ 开启插队时跳过大文件继续尝试
       │
7. 防死锁
   └─ 无活跃下载且未放行任何任务 → 强制放行第一个
       │
8. 发送通知
```

## 注意事项

- 本插件仅支持 qBittorrent 下载器，依赖 qBittorrent 原生种子状态和 `save_path` 字段
- 磁盘空间检测基于 `psutil.disk_usage`，检测的是下载目录所在磁盘（挂载点）的剩余空间
- 未被监控目录覆盖的种子不受磁盘空间保护
- 插件通过 MoviePilot 的 `DownloaderHelper` 操作下载器，需在系统设置中正确配置下载器连接
